# Amazon Cognito 実践学習ガイド

## はじめに

このガイドでは、Amazon Cognito の実務レベルの機能を網羅的に学習します。マルチテナント型タスク管理アプリ「TaskFlow」を構築しながら、認証・認可の基礎から高度なセキュリティ機能まで実践的に習得します。

### 到達目標

- Cognito User Pools を使用した認証システムの設計・実装
- パスキー（WebAuthn/FIDO2）によるパスワードレス認証の実装
- MFA（TOTP、SMS、Email）の設定と実装
- ソーシャルログイン（Google）の統合
- Lambda Triggers によるカスタマイズ
- Identity Pools を使用した AWS リソースへのアクセス制御
- JWT トークンの検証と API 保護

## 対象読者

| 項目           | 要件                                         |
| -------------- | -------------------------------------------- |
| AWS 経験       | ECS、CloudFront、S3 などの基本的な使用経験   |
| 認証経験       | 不要（このガイドで基礎から学習）             |
| TypeScript     | 基本的な文法を理解している                   |
| Angular        | コンポーネント、サービス、ルーティングの基礎 |
| フロントエンド | SPA の基本概念を理解している                 |

## 技術スタック

| カテゴリ       | 技術                 | 用途                        |
| -------------- | -------------------- | --------------------------- |
| フロントエンド | Angular 19+          | SPA フレームワーク          |
| バックエンド   | Hono + TypeScript    | REST API サーバー           |
| 認証           | Amazon Cognito       | User Pools / Identity Pools |
| IaC            | AWS CDK (TypeScript) | インフラストラクチャ定義    |
| データベース   | Amazon DynamoDB      | タスク・組織データの永続化  |
| ホスティング   | CloudFront + S3      | フロントエンド配信          |
| API 実行環境   | AWS Lambda           | バックエンド実行            |
| API Gateway    | Amazon API Gateway   | REST API エンドポイント     |

## 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              クライアント                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Angular SPA (TaskFlow)                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │   │
│  │  │  認証    │  │  タスク  │  │  組織    │  │  ユーザー管理    │   │   │
│  │  │  画面    │  │  管理    │  │  管理    │  │  (Admin)         │   │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AWS Cloud                                          │
│                                                                              │
│  ┌──────────────┐     ┌──────────────────────────────────────────────────┐ │
│  │  CloudFront  │────▶│                 S3 (SPA)                         │ │
│  └──────────────┘     └──────────────────────────────────────────────────┘ │
│         │                                                                    │
│         ▼                                                                    │
│  ┌──────────────┐     ┌──────────────────────────────────────────────────┐ │
│  │ API Gateway  │────▶│              Lambda (Hono API)                   │ │
│  │  + Cognito   │     │  ┌────────┐  ┌────────┐  ┌────────────────────┐ │ │
│  │  Authorizer  │     │  │ Tasks  │  │ Orgs   │  │ Users (Admin)      │ │ │
│  └──────────────┘     │  └────────┘  └────────┘  └────────────────────┘ │ │
│                       └──────────────────────────────────────────────────┘ │
│                                      │                                      │
│                                      ▼                                      │
│                       ┌──────────────────────────────────────────────────┐ │
│                       │                  DynamoDB                         │ │
│                       │  ┌────────┐  ┌────────┐  ┌────────────────────┐ │ │
│                       │  │ Tasks  │  │ Orgs   │  │ UserOrgs           │ │ │
│                       │  └────────┘  └────────┘  └────────────────────┘ │ │
│                       └──────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        Amazon Cognito                                  │ │
│  │  ┌─────────────────────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │         User Pools              │  │      Identity Pools         │ │ │
│  │  │  ┌─────────┐  ┌──────────────┐ │  │  ┌─────────────────────────┐│ │ │
│  │  │  │ Users   │  │ Groups       │ │  │  │ AWS Credentials         ││ │ │
│  │  │  │         │  │ Admin/Member │ │  │  │ (S3 Access etc.)        ││ │ │
│  │  │  └─────────┘  └──────────────┘ │  │  └─────────────────────────┘│ │ │
│  │  │  ┌─────────────────────────────┐│  └─────────────────────────────┘ │ │
│  │  │  │ Authentication Methods     ││                                   │ │
│  │  │  │ • Password + MFA           ││                                   │ │
│  │  │  │ • Passkey (WebAuthn)       ││                                   │ │
│  │  │  │ • Social (Google)          ││                                   │ │
│  │  │  │ • Email OTP                ││                                   │ │
│  │  │  └─────────────────────────────┘│                                   │ │
│  │  └─────────────────────────────────┘                                   │ │
│  │                     │                                                   │ │
│  │                     ▼                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │                    Lambda Triggers                               │  │ │
│  │  │  ┌──────────┐ ┌───────────────┐ ┌────────────────────────────┐ │  │ │
│  │  │  │Pre SignUp│ │Post Confirm   │ │Pre Token Generation        │ │  │ │
│  │  │  └──────────┘ └───────────────┘ └────────────────────────────┘ │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 学習ロードマップ

| 章  | タイトル                           | 内容                                                 |
| --- | ---------------------------------- | ---------------------------------------------------- |
| 01  | Cognito の基礎と環境構築           | User Pools の概念、CDK によるインフラ構築            |
| 02  | 基本認証フローの実装               | サインアップ、サインイン、メール検証                 |
| 03  | Angular 認証 UI の構築             | 認証画面、AuthGuard、状態管理                        |
| 04  | Hono API と JWT 検証               | Cognito Authorizer、JWT 検証ミドルウェア             |
| 05  | MFA（多要素認証）の実装            | TOTP、SMS、Email OTP の設定と実装                    |
| 06  | パスキー認証の実装                 | WebAuthn/FIDO2 によるパスワードレス認証              |
| 07  | ソーシャルログインの統合           | Google ログイン、Hosted UI                           |
| 08  | グループと権限管理                 | Cognito Groups、ロールベースアクセス制御             |
| 09  | Lambda Triggers によるカスタマイズ | Pre Sign-up、Post Confirmation、Pre Token Generation |
| 10  | Identity Pools と AWS リソース連携 | 一時的な AWS 認証情報の取得、S3 アクセス             |
| 11  | Advanced Security                  | 適応型認証、侵害された認証情報の検出                 |
| 12  | 本番環境への展開                   | セキュリティベストプラクティス、監視、運用           |

## プロジェクト構成

```
taskflow/
├── apps/
│   ├── web/                    # Angular フロントエンド
│   │   ├── src/
│   │   │   ├── app/
│   │   │   │   ├── auth/       # 認証関連コンポーネント
│   │   │   │   ├── tasks/      # タスク管理
│   │   │   │   ├── orgs/       # 組織管理
│   │   │   │   ├── admin/      # 管理者機能
│   │   │   │   └── shared/     # 共通コンポーネント
│   │   │   └── environments/
│   │   └── angular.json
│   │
│   └── api/                    # Hono バックエンド
│       ├── src/
│       │   ├── routes/         # API ルート
│       │   ├── middleware/     # JWT 検証など
│       │   ├── services/       # ビジネスロジック
│       │   └── index.ts
│       └── package.json
│
├── infra/                      # AWS CDK
│   ├── lib/
│   │   ├── cognito-stack.ts    # Cognito 設定
│   │   ├── api-stack.ts        # API Gateway + Lambda
│   │   ├── frontend-stack.ts   # CloudFront + S3
│   │   └── database-stack.ts   # DynamoDB
│   └── bin/
│       └── infra.ts
│
├── packages/
│   └── shared/                 # 共有型定義
│       └── src/
│           └── types/
│
└── docs/
    └── guide/                  # この学習ガイド
```

## 作成するアプリケーション「TaskFlow」

TaskFlow は、組織（テナント）ごとにタスクを管理するマルチテナント型アプリケーションです。

### 主な機能

- **認証**: パスワード、パスキー、Google ログイン、MFA
- **組織管理**: 組織の作成、メンバー招待
- **タスク管理**: タスクの CRUD、担当者アサイン
- **権限管理**: Admin / Member ロールによるアクセス制御

### ユーザーストーリー

1. ユーザーはメールアドレスでサインアップし、メール検証を完了する
2. ユーザーは MFA（TOTP）を設定してセキュリティを強化する
3. ユーザーはパスキーを登録し、次回からパスワードなしでログインする
4. ユーザーは組織を作成し、他のユーザーを招待する
5. Admin ユーザーは組織のメンバーを管理できる
6. ユーザーはタスクを作成し、組織メンバーにアサインする

## 参考文献

### 公式ドキュメント

- [Amazon Cognito Developer Guide](https://docs.aws.amazon.com/cognito/latest/developerguide/)
- [AWS Amplify Auth Documentation](https://docs.amplify.aws/lib/auth/getting-started/)
- [Angular Documentation](https://angular.dev/)
- [Hono Documentation](https://hono.dev/)

### 関連仕様

- [WebAuthn Specification](https://www.w3.org/TR/webauthn-2/)
- [FIDO2 Overview](https://fidoalliance.org/fido2/)
- [OAuth 2.0 / OpenID Connect](https://openid.net/connect/)

---

次の章: [01 - Cognito の基礎と環境構築](./01-cognito-basics.md)
